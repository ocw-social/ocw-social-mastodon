name: Publish / Mastodon container images

on:
  # Run every Monday at 12:00 EDT (16:00 UTC)
  schedule:
    - cron: "0 16 * * MON"
  # Allow manual trigger 
  workflow_dispatch: 
    inputs:
      isDev:
        description: "Is dev?"
        required: false
        type: boolean
        default: false

permissions:
  actions: write
  packages: write

jobs:
    build:
      name: Build and push container image
      runs-on: ubuntu-latest

      env:
        IMAGE_NAME: ${{ inputs.isDev == true && 'ocw-social-mastodon-dev' || 'ocw-social-mastodon' }}

      steps:
        - name: 'Checkout: Latest commit'
          uses: actions/checkout@v4
          with:
            submodules: true

        - name: Set up Docker Buildx
          uses: docker/setup-buildx-action@v3

        - name: Log into Azure container registry
          uses: docker/login-action@v3
          with:
            registry: smallsonlinemstdncontainers.azurecr.io
            username: ${{ secrets.REGISTRY_USERNAME }}
            password: ${{ secrets.REGISTRY_PASSWORD }}

        - name: Log into GitHub container registry
          uses: docker/login-action@v3
          with:
            registry: ghcr.io
            username: ${{ github.repository_owner }}
            password: ${{ secrets.GITHUB_TOKEN }}

        - name: Set metadata
          id: meta
          uses: docker/metadata-action@v5
          with:
            images: |
              smallsonlinemstdncontainers.azurecr.io/${{ env.IMAGE_NAME }}
              ghcr.io/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}
            tags: |
              type=raw,value=latest,enable={{is_default_branch}}
              type=schedule,pattern={{date 'YYYYMMDD-hhmmss' tz='UTC'}}
              type=ref,event=branch
              type=sha

        - name: Build and push container image to registry
          uses: docker/build-push-action@v5
          with:
            context: ./
            file: ./Dockerfile
            push: true
            tags: ${{ steps.meta.outputs.tags }}
            platforms: linux/amd64,linux/arm64
